<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Romper Demo Stories</title>
    <link href="../dist/romper.css" rel="stylesheet" type="text/css">
    <link href="styles.css" rel="stylesheet" type="text/css">
    <link href="demos.css" rel="stylesheet" type="text/css">
    <link href="../node_modules/jsoneditor/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="../node_modules/jsoneditor/dist/jsoneditor.min.js"></script>
</head>

<body>
    <h1>OBM Toolkit Experience Demos</h1>
    
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'chooser')">Select story</button>
        <button class="tablinks" onclick="openTab(event, 'jsoncontent')">View Data Model JSON</button>
        <button class="tablinks" onclick="openTab(event, 'renderer')">Render</button>
    </div>

    <!-- Select a story -->
    <div id='chooser' class='tabcontent' style='display: block;'>
        <div class='selection'>
            <div>
                <h3>Linear</h3>
                <p>A simple linear story with 3 parts.</p>
                <p><button onclick="loadStory('demo1.json')">Select</button></p>
            </div>
            <div>
                <h3>Branching</h3> 
                <p>A branching story with a shared start, then two alternatives: a short conclusion, or a more in-depth version with two more parts.</p>
                <p><button onclick="loadStory('demo2.json')">Select</button></p>
            </p>
            </div>
            <div>
                <h3>Multi-representation</h3>
                <p>A simple linear story with 3 parts, with the option to view a video version or an image-based version.</p>
                <p><button onclick="loadStory('demo3')">Select</button></p>    
            </div>
        </div>
    </div>

    <!-- View rendered content -->
    <div id='renderer' class='tabcontent'>
        <h2 id='story-title' class='story-title'>No story selected</h2>
        <div id="romper-target">
            <p class='render-placeholder'>Select a demo story and it will be rendered here.</p>
        </div>

        <!-- Allow user to modify variables -->
        <div id='variable-pane'class='variable-setter active'>
            <h3>Modify variable values here</h3>
            <p>The first Narrative Element is already loaded, so will not be immediately affected by changes.</p>
            <div id='variables-generic'>Load a story to see its variables.</div>
        </div>
    </div>

    <!-- View/edit json -->
    <div id='jsoncontent' class='jsoncontent tabcontent'>
        <div id='json-view'>
Select a demo story and the story json will be shown here.
        </div>
        <p><button id='runjson' onclick="runEditedJson()" disabled>Run</button></p>    
    </div>

    <div id='feedback' class='feedback'></div>

    <script src="../dist/romper.js"></script>
    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function showMessage(messageText, error=false) {
            const messageDiv = document.getElementById('feedback');
            messageDiv.textContent = messageText;
            if (error) {
                messageDiv.classList.add('warning');
            } else {
                messageDiv.classList.remove('warning');
            }
        }

        const getFilename = getParameterByName('storyjson');
        if (getFilename) {
            loadStory(getFilename);
        }

        const options = {
            mode: 'tree',
        };
        const jsonEditor = new JSONEditor(document.getElementById('json-view'), options);

        // handle changing tabs
        function openTab(evt, demoName) {
            
            // Get all elements with class="tabcontent" and hide them
            var tabcontent = document.getElementsByClassName("tabcontent");
            for (var i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
        
            // Get all elements with class="tablinks" and remove the class "active"
            var tablinks = document.getElementsByClassName("tablinks");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
        
            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(demoName).style.display = "block";
            evt.currentTarget.className += " active";
        } 

        // run edited json
        function runEditedJson() {
            document.getElementById('romper-target').innerHTML = '';
            const storyJson = jsonEditor.get();
            try {
                run(storyJson);
                showMessage('Story loaded - view the renderer.');

            } catch (e) {
                showMessage('Could not run your json - see the console!');
                console.log(e);
            }
        }

        // run some json through romper
        function run(config) {
            document.getElementById('runjson').removeAttribute('disabled');
            document.getElementById('runjson').classList.add('active');
            document.getElementById('story-title').textContent = config.stories[0].name;
            jsonEditor.set(config);
            let romper = window.Romper.init({
                target: document.getElementById('romper-target'),
                analyticsLogger: dataObj => {
                    console.log('ANALYTICS:', dataObj);
                },
                storyFetcher: id => Promise.resolve().then(
                    () => config.stories.filter(storyObject => storyObject.id === id)[0]
                ),
                mediaFetcher: uri => Promise.resolve(uri).then(resolvedUri => resolvedUri ? resolvedUri : Promise.reject('cannot resolve uri')),
                representationCollectionFetcher: id => Promise.resolve(
                    config.representation_collections
                        .filter(presentationObject => presentationObject.id === id)[0]
                ).then(presentationObject => presentationObject ? presentationObject : Promise.reject('no such presentation object: ' + id)),
                assetCollectionFetcher: id => Promise.resolve(
                    config.asset_collections
                        .filter(assetCollectionObject => assetCollectionObject.id === id)[0]
                ).then(assetCollectionObject => assetCollectionObject ? assetCollectionObject : Promise.reject('no such asset collection: ' + id)),
                representationFetcher: id => Promise.resolve(
                    config.representations
                        .filter(representationObject => representationObject.id === id)[0]
                ).then(representationObject => representationObject ? representationObject : Promise.reject('no such representation: ' + id)),
                narrativeElementFetcher: id => Promise.resolve(
                    config.narrative_elements
                        .filter(narrativeElementObject => narrativeElementObject.id === id)[0]
                ).then(narrativeElementObject => narrativeElementObject ? narrativeElementObject : Promise.reject('no such narrative element: ' + id)),
            });

            if (config.stories[0].variables) {
                console.log(config.stories[0].variables);
                addVariableControls(config.stories[0].variables, romper);
            } else {
                const varPanel = document.getElementById('variables-generic');
                varPanel.innerHTML = 'There are no variables in this story';
            }

            romper.start(config.stories[0].id);
            romper.on('ControllerReady', () => {
                console.log('romper ready - setting variable values');
            });
        }

        // fetch a story, load and run it
        function loadStory(filepath) {
            showMessage(`Loading ${filepath}`);
            document.getElementById('romper-target').innerHTML = '';
            fetch(filepath)
                .then((response) => {
                    if (response.ok) {
                        return Promise.resolve(response.text());
                    }
                    return Promise.reject(response);
                })
                .then((text) => {
                    showMessage('Story loaded');
                    run(JSON.parse(text));
                })
                .catch((rejection) => {
                    showMessage(`could not fetch story content: ${rejection.status} ${rejection.statusText}`, true);
                });
        };

        function addVariableControls(variableDeclaration, romperInstance) {
            const varPanel = document.getElementById('variables-generic');
            varPanel.innerHTML = '';
            Object.keys(variableDeclaration).forEach((varName) => {
                const varDecl = variableDeclaration[varName]
                const varType = varDecl.variable_type;
                if (varType === 'boolean') {
                    addBooleanVariableSwitch(varName, varDecl, romperInstance);
                }
            });
        }

        function addBooleanVariableSwitch(varName, variableDecl, romperInstance){
            console.log('adding boolean');
            const varValue = variableDecl.default_value;
            const varDesc = variableDecl.description;
            const parEl = document.createElement('p');
            const nameSpan = document.createElement('span');
            nameSpan.classList.add('slider-choice');
            nameSpan.textContent = varName;
            varInput = document.createElement('input');
            varInput.id = varName;
            varInput.type = 'checkbox';
            const sliderSpan = document.createElement('span');
            const label = document.createElement('label');
            label.classList.add('switch');

            label.appendChild(varInput);
            label.appendChild(sliderSpan);
            parEl.appendChild(label);
            parEl.appendChild(nameSpan);

            if (varValue) { varInput.setAttribute('checked', true); }
            varInput.onchange = () => romperInstance.setVariableValue(varName, varInput.checked);

            const varPanel = document.getElementById('variables-generic');
            varPanel.appendChild(parEl);
        }

    </script>
</body>

</html>
